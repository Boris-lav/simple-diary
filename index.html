<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Simple Diary</title>
  <style>
    :root {
      --bg: #0b0c0f;
      --panel: #151821;
      --text: #e6e6e6;
      --muted: #a9b0be;
      --accent: #7aa2f7;
      --danger: #ef4444;
      --ok: #22c55e;
      --border: #2a2f3a;
    }
    :root.light {
      --bg: #f7f8fb;
      --panel: #ffffff;
      --text: #111827;
      --muted: #4b5563;
      --accent: #2563eb;
      --danger: #b91c1c;
      --ok: #16a34a;
      --border: #e5e7eb;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg);
      color: var(--text);
      line-height: 1.4;
    }

    .container {
      max-width: 980px;
      margin: 0 auto;
      padding: 24px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 20px;
    }
    .brand { font-weight: 700; letter-spacing: 0.3px; }
    .muted { color: var(--muted); }

    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 20px;
      box-shadow: 0 10px 24px rgba(0,0,0,.12);
    }

    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .grow { flex: 1 1 240px; }

    input, textarea, select, button {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--border);
      padding: 10px 12px;
      border-radius: 10px;
      outline: none;
      width: 100%;
    }
    textarea { min-height: 140px; resize: vertical; }
    button {
      cursor: pointer; border: 1px solid var(--border);
      background: linear-gradient(180deg, color-mix(in oklab, var(--accent) 18%, transparent), transparent);
    }
    button.primary { border-color: color-mix(in oklab, var(--accent) 50%, var(--border)); }
    button.danger { border-color: color-mix(in oklab, var(--danger) 60%, var(--border)); }
    button.ok { border-color: color-mix(in oklab, var(--ok) 60%, var(--border)); }

    .toolbar { display: flex; gap: 10px; flex-wrap: wrap; }

    .entry { padding: 14px; border: 1px solid var(--border); border-radius: 12px; }
    .entry header { margin: 0 0 8px 0; }
    .entry-title { font-weight: 600; }

    .spacer { height: 8px; }

    .hidden { display: none !important; }

    .switch {
      display: inline-flex; align-items: center; gap: 8px; cursor: pointer;
      user-select: none;
    }
    .switch input { display: none; }
    .switch .track {
      width: 42px; height: 24px; border-radius: 999px; position: relative;
      background: var(--border);
    }
    .switch .thumb {
      position: absolute; top: 3px; left: 3px; width: 18px; height: 18px;
      border-radius: 50%; background: var(--text); transition: transform .2s ease;
    }
    .switch input:checked + .track .thumb { transform: translateX(18px); }

    .notice { font-size: 14px; color: var(--muted); }
    .right { margin-left: auto; }
    .nowrap { white-space: nowrap; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    footer { margin-top: 24px; color: var(--muted); font-size: 14px; display: flex; justify-content: space-between; gap: 12px; align-items: center; }
    a { color: var(--accent); text-decoration: none; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header>
      <div>
        <div class="brand">ðŸ““ Simple Diary</div>
        <div class="muted" id="welcome"></div>
      </div>
      <label class="switch" title="Toggle dark mode">
        <input type="checkbox" id="themeToggle" />
        <div class="track"><div class="thumb"></div></div>
        <span class="muted nowrap">Dark mode</span>
      </label>
    </header>

    <!-- Auth Panel -->
    <section class="panel" id="authPanel">
      <h2 style="margin-top:0">Sign in</h2>
      <div class="notice">
        Data syncs to your backend when signed in (via API). If not signed in, it saves temporarily in your browser.
        Do not use real passwords.
      </div>
      <div class="spacer"></div>
      <div class="row">
        <div class="grow"><label>Username<input id="username" autocomplete="username" /></label></div>
        <div class="grow"><label>Password<input id="password" type="password" autocomplete="current-password" /></label></div>
      </div>
      <div class="spacer"></div>
      <div class="toolbar">
        <button class="primary" id="loginBtn">Sign in</button>
        <button id="registerBtn">Register</button>
      </div>
    </section>

    <!-- App Panel -->
    <section class="panel hidden" id="appPanel">
      <div class="row" style="align-items:center; margin-bottom: 8px;">
        <div class="grow"><h2 style="margin:0">Your entries</h2></div>
        <div class="toolbar">
          <button id="exportBtn" class="ok">Export JSON</button>
          <label for="importFile" class="button-like" style="display:inline-flex;align-items:center;gap:8px;cursor:pointer; border:1px solid var(--border); padding:10px 12px; border-radius:10px;">Import JSON<input type="file" id="importFile" accept="application/json" class="hidden"/></label>
          <button id="logoutBtn" class="danger">Logout</button>
        </div>
      </div>

      <div class="row">
        <div class="grow">
          <label>Date
            <input type="date" id="entryDate" />
          </label>
        </div>
        <div class="grow">
          <label>Title
            <input type="text" id="entryTitle" placeholder="Optional title" />
          </label>
        </div>
      </div>
      <div class="spacer"></div>
      <label>Entry
        <textarea id="entryText" placeholder="What happened today?"></textarea>
      </label>
      <div class="spacer"></div>
      <div class="toolbar">
        <button id="saveEntry" class="primary">Save entry</button>
        <span class="notice" id="saveMsg"></span>
      </div>

      <div class="spacer"></div>
      <hr style="border:0; border-top:1px solid var(--border)">
      <div id="entriesList" style="margin-top:14px; display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px;"></div>
    </section>

    <footer>
      <span class="notice">Signed-in: backend API â€¢ Signed-out: local (temporary). You can migrate old local notes later.</span>
      <a href="https://developer.mozilla.org/" target="_blank" rel="noopener">MDN</a>
    </footer>
  </div>

  <script>
    // =========================
    // Utilities & Theme
    // =========================
    const $ = (id) => document.getElementById(id);
    const escapeHTML = (s) => String(s)
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#039;');

    async function sha256(str) {
      if (window.crypto?.subtle) {
        const enc = new TextEncoder().encode(str);
        const hash = await crypto.subtle.digest('SHA-256', enc);
        return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
      }
      let h = 0; for (let i=0;i<str.length;i++){h=(h<<5)-h+str.charCodeAt(i); h|=0;} return String(h);
    }

    function getTheme(){ return localStorage.getItem('theme') || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'); }
    function setTheme(theme){ localStorage.setItem('theme', theme); document.documentElement.classList.toggle('light', theme==='light'); $('themeToggle').checked = theme==='dark'; }
    setTheme(getTheme());
    $('themeToggle').addEventListener('change', (e)=> setTheme(e.target.checked ? 'dark' : 'light'));

    // =========================
    // Session (username for header)
    // =========================
    function setSession(user){ sessionStorage.setItem('user', user); }
    function getSession(){ return sessionStorage.getItem('user'); }
    function clearSession(){ sessionStorage.removeItem('user'); }

    // =========================
    // Local fallback storage (for unsigned / offline)
    // =========================
    function saveUsers(users){ localStorage.setItem('users', JSON.stringify(users)); }
    function getUsers(){ try { return JSON.parse(localStorage.getItem('users')||'{}'); } catch { return {}; } }
    function keyFor(user){ return `diary_${user}`; }
    function loadEntriesLocal(user){ try { return JSON.parse(localStorage.getItem(keyFor(user))||'[]'); } catch { return []; } }
    function saveEntriesLocal(user, entries){ localStorage.setItem(keyFor(user), JSON.stringify(entries)); }

    // =========================
    // API adapter (set API_BASE!)
    // =========================
    const API_BASE = 'https://<your-api-host>'; // e.g., http://localhost:8080 or https://diary-api.onrender.com
    let token = localStorage.getItem('token') || '';
    function isSignedIn(){ return Boolean(token); }

    async function api(path, opts={}){
      const res = await fetch(`${API_BASE}${path}`, {
        headers: {
          'Content-Type': 'application/json',
          ...(token ? { Authorization: `Bearer ${token}` } : {})
        },
        ...opts
      });
      if(!res.ok){
        const err = await res.json().catch(()=>({ error: 'Request failed'}));
        throw new Error(err.error || res.statusText);
      }
      return res.json();
    }

    // Auth via API
    async function registerUser(username, password){
      await api('/api/auth/register', { method:'POST', body: JSON.stringify({ username, password }) });
    }
    async function loginUser(username, password){
      const out = await api('/api/auth/login', { method:'POST', body: JSON.stringify({ username, password }) });
      token = out.token; localStorage.setItem('token', token);
      return out.user; // { id, username } (ensure your backend returns this)
    }
    function logoutUser(){ token=''; localStorage.removeItem('token'); }

    // Entries via API
    async function listEntries(){ return api('/api/entries'); }
    async function createEntryAPI({date, title, text}){
      return api('/api/entries', { method:'POST', body: JSON.stringify({ date, title, text }) });
    }
    async function updateEntryAPI(id, data){
      return api(`/api/entries/${id}`, { method:'PUT', body: JSON.stringify(data) });
    }
    async function deleteEntryAPI(id){
      return api(`/api/entries/${id}`, { method:'DELETE' });
    }

    // =========================
    // UI helpers
    // =========================
    function showApp(userLabel){
      $('authPanel').classList.add('hidden');
      $('appPanel').classList.remove('hidden');
      $('welcome').textContent = `Signed in as @${userLabel}`;
      $('entryDate').valueAsDate = new Date();
      renderEntries();
    }
    function showAuth(){
      $('authPanel').classList.remove('hidden');
      $('appPanel').classList.add('hidden');
      $('welcome').textContent = '';
    }

    // =========================
    // Auth button handlers (API-first, fallback to local)
    // =========================
    $('registerBtn').addEventListener('click', async ()=>{
      const username = $('username').value.trim(); const password = $('password').value;
      if(!username || !password){ alert('Username and password required'); return; }
      try{
        if (API_BASE.includes('<your-api-host>')) throw new Error('Set API_BASE first');
        await registerUser(username, password);
        alert('Registered! You can sign in now.');
      } catch(e){
        // Fallback: local register
        try{
          const users = getUsers();
          if (users[username]) throw new Error('User already exists (local)');
          users[username] = { pass: await sha256(password), createdAt: Date.now() };
          saveUsers(users);
          alert('Registered locally (fallback). Set API_BASE and try backend later.');
        } catch(err){ alert(err.message); }
      }
    });

    $('loginBtn').addEventListener('click', async ()=>{
      const username = $('username').value.trim(); const password = $('password').value;
      if(!username || !password){ alert('Username and password required'); return; }
      try{
        if (API_BASE.includes('<your-api-host>')) throw new Error('Set API_BASE first');
        const user = await loginUser(username, password);
        setSession(user?.username || username);
        showApp(user?.username || username);
      } catch(e){
        // Fallback: local login
        try{
          const users = getUsers();
          const u = users[username];
          if (!u) throw new Error('User not found (local)');
          const ok = u.pass === await sha256(password);
          if (!ok) throw new Error('Invalid password (local)');
          setSession(username);
          showApp(username);
          alert('Using local mode (no backend token).');
        } catch(err){ alert(err.message); }
      }
    });

    $('logoutBtn').addEventListener('click', ()=>{
      logoutUser();
      clearSession();
      showAuth();
    });

    // =========================
    // Entries: API-first with local fallback
    // =========================
    async function fetchEntries(){
      if (isSignedIn()){
        try { return await listEntries(); }
        catch(e){ console.warn('Entries API failed, falling back to local:', e.message); }
      }
      const user = getSession(); if(!user) return [];
      return loadEntriesLocal(user);
    }

    async function addEntry({date, title, text}){
      if (isSignedIn()){
        try { return await createEntryAPI({date, title, text}); }
        catch(e){ console.warn('Create API failed, saving local:', e.message); }
      }
      const user = getSession(); if(!user) return;
      const entries = loadEntriesLocal(user);
      const id = crypto.randomUUID ? crypto.randomUUID() : (Date.now()+"_"+Math.random().toString(36).slice(2));
      entries.unshift({ id, date, title, text, updatedAt: Date.now() });
      saveEntriesLocal(user, entries);
      return { id, date, title, text };
    }

    async function editEntry(id, data){
      if (isSignedIn()){
        try { return await updateEntryAPI(id, data); }
        catch(e){ console.warn('Update API failed, updating local:', e.message); }
      }
      const user = getSession(); if(!user) return;
      const entries = loadEntriesLocal(user);
      const item = entries.find(x=> (x.id || x._id) === id);
      if (!item) return;
      Object.assign(item, data, { updatedAt: Date.now() });
      saveEntriesLocal(user, entries);
      return item;
    }

    async function removeEntry(id){
      if (isSignedIn()){
        try { return await deleteEntryAPI(id); }
        catch(e){ console.warn('Delete API failed, deleting local:', e.message); }
      }
      const user = getSession(); if(!user) return;
      const entries = loadEntriesLocal(user).filter(x=> (x.id || x._id) !== id);
      saveEntriesLocal(user, entries);
      return { ok: true };
    }

    // Create
    $('saveEntry').addEventListener('click', async ()=>{
      const user = getSession(); if(!user && !isSignedIn()) return;
      const date = $('entryDate').value || new Date().toISOString().slice(0,10);
      const title = $('entryTitle').value.trim();
      const text = $('entryText').value.trim();
      if(!text){ $('saveMsg').textContent = 'Nothing to save'; return; }
      try{
        await addEntry({ date, title, text });
        $('entryTitle').value = '';
        $('entryText').value = '';
        $('saveMsg').textContent = 'Saved!';
        setTimeout(()=> $('saveMsg').textContent = '', 1500);
        renderEntries();
      } catch(err){
        alert('Save failed: ' + err.message);
      }
    });

    // Render list (supports API or local shapes)
    async function renderEntries(){
      const root = $('entriesList'); root.innerHTML = '';
      const entries = await fetchEntries();

      if(!entries || entries.length===0){
        root.innerHTML = `<div class="muted">No entries yet. Your saved notes will appear here.</div>`;
        return;
      }

      for(const e of entries){
        const id = e.id || e._id;                 // support both shapes
        const title = e.title || '(No title)';
        const text = e.text ?? e.content ?? '';   // API might use 'text' or 'content'
        const date = (e.date ? String(e.date).slice(0,10) : '');

        const div = document.createElement('div');
        div.className = 'entry';
        div.innerHTML = `
          <header class="row" style="margin:0 0 8px 0; align-items:center;">
            <div class="entry-title grow">${escapeHTML(title)}</div>
            <div class="muted mono">${escapeHTML(date)}</div>
          </header>
          <div class="muted" style="white-space:pre-wrap;">${escapeHTML(text)}</div>
          <div class="toolbar" style="margin-top:10px;">
            <button data-action="edit" data-id="${id}">Edit</button>
            <button class="danger" data-action="delete" data-id="${id}">Delete</button>
          </div>
        `;
        root.appendChild(div);
      }

      // Delegate edit/delete
      root.querySelectorAll('button').forEach(btn=> btn.addEventListener('click', async (ev)=>{
        const id = ev.target.getAttribute('data-id');
        const action = ev.target.getAttribute('data-action');
        if(action==='delete'){
          if(!confirm('Delete this entry?')) return;
          await removeEntry(id);
          renderEntries();
        } else if(action==='edit'){
          // basic prompt editors
          const entriesNow = await fetchEntries();
          const item = entriesNow.find(x => (x.id || x._id) === id);
          if(!item) return;
          const newTitle = prompt('Edit title:', item.title||'');
          if (newTitle === null) return;
          const currentText = item.text ?? item.content ?? '';
          const newText = prompt('Edit text (use Shift+Enter for new lines in a real app):', currentText);
          if(newText===null) return;
          await editEntry(id, { title: newTitle || '', text: newText });
          renderEntries();
        }
      }));
    }

    // =========================
    // Export / Import (API-aware)
    // =========================
    $('exportBtn').addEventListener('click', async ()=>{
      try{
        const data = await fetchEntries();
        const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `diary_${(getSession()||'user')}_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
        URL.revokeObjectURL(a.href);
      } catch(err){
        alert('Export failed: ' + err.message);
      }
    });

    $('importFile').addEventListener('change', async (e)=>{
      const file = e.target.files?.[0]; if(!file) return;
      const text = await file.text();
      try {
        const data = JSON.parse(text);
        if(!Array.isArray(data)) throw new Error('Invalid file');
        // Create one-by-one via API if signed in; else merge locally
        if (isSignedIn()){
          for (const it of data){
            const payload = {
              date: it.date ? String(it.date).slice(0,10) : undefined,
              title: it.title || '',
              text: it.text ?? it.content ?? ''
            };
            if (!payload.text) continue;
            await createEntryAPI(payload);
          }
        } else {
          const user = getSession(); if(!user) throw new Error('Not signed in and no local user');
          const existing = loadEntriesLocal(user);
          const ids = new Set(existing.map(x=>x.id||x._id));
          const merged = [...data.filter(x=> x && (x.id||x._id) && !ids.has(x.id||x._id)), ...existing];
          saveEntriesLocal(user, merged);
        }
        renderEntries();
        alert('Imported successfully.');
      } catch(err){
        alert('Import failed: '+err.message);
      } finally { e.target.value = ''; }
    });

    // =========================
    // Auto-restore
    // =========================
    (async function boot(){
      // If token exists from previous session, go straight to app
      if (isSignedIn()){
        setSession(getSession() || 'you');
        showApp(getSession());
        return;
      }
      const current = getSession();
      if(current){ showApp(current); }
    })();
  </script>
</body>
</html>
